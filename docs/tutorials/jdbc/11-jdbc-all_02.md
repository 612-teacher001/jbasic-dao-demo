# *T1.11* JDBC接続によるCRUD操作・全件検索 ～ データベースに接続してみた・try-with-resources導入編

[Javaによるデータベース接続とCRUD操作のチュートリアル](../tutorials.md) > [JDBC接続によるCRUD操作](./10-jdbc.md)

### 今回のチュートリアル対象

- コミット：[a97d20b](https://github.com/612-teacher001/jbasic-dao-demo/commit/a97d20b)
- クラス：[`jp.example.app.t1.JdbcAll`](https://github.com/612-teacher001/jbasic-dao-demo/blob/main/src/main/java/jp/example/app/t1/JdbcAll.java)

👉 チュートリアルの進め方については [チュートリアルガイド](../guidance.md) を参照してください。

## 1. 概要

このチュートリアルで扱うプログラムは、productsテーブルからすべてのレコードを取得して、標準出力に表示するというものです。

このチュートリアルでは、前回のチュートリアルで指摘した問題点を解消するために、**データベース接続関連オブジェクトについて `try-with-resources` を導入してソースコードを簡素化する方法** について解説します。

処理結果の表示仕様は以下のとおりです（前回のチュートリアルと同じ）：
  - **取得順序**：主キー（`id` フィールド）の昇順
  - **出力形式**：商品ID、カテゴリID、商品名、価格、数量
  - **例外処理**：SQL実行中にエラーが発生した場合にはスタックトレースを表示

## 2. 事前準備

データベースの詳細については、データベース接続情報を含めて [データベース概要](../00-database.md) を参照してください。

## 3. 手順ごとの解説

以下で解説する手順は `jp.example.app.t1.JdbcAll#main(String[])` メソッドのコードに記述されている「手順-X」と記述されたコメントに対応しています。  
実際にコードを確認しながら読み進めてください。

手順-3から手順-5までのコードについて解説します。  
それ以外の手順については、[前回のチュートリアル](./11-jdbc-all_01.md) と同じ内容になるので省略します。

### 手順-3. データベース接続オブジェクトを取得する
```java
try (// 手順-3. 接続情報をもとにデータベース接続オブジェクトを取得
    Connection conn 
    = DriverManager.getConnection(
                    configure.getUrl(), 
                    configure.getUser(), 
                    configure.getPassword());
  
    // 手順-4. SQL実行オブジェクトを取得
    PreparedStatement pstmt = conn.prepareStatement(sql);
    // 手順-5. SQLの実行と結果セットを取得
    ResultSet rs = pstmt.executeQuery();
  ) {
...
```
- データベース接続関連オブジェクトのように必ず破棄する必要があるオブジェクトを自動的に破棄するしくみを **`try-with-resources`** といいます。  
このしくみを利用すると、オブジェクトの破棄は内部で実行されるので破棄することを忘れるというリクスがなくなります。
- `try-with-resources` の書式は以下のとおりです：
```java
try (...) {
  ...(tryブロック)
} catch (Exception e) {
  ...(例外処理)..
}
```
- `try` の後ろに続く丸括弧内でオブジェクトを宣言して生成します。  
この丸括弧の内部を **オブジェクト宣言領域** といい、この領域で宣言されたオブジェクトは `try` ブロック内で利用することができます。  
`try` ブロックから抜けるときにこれらのオブジェクトは内部で破棄されます。  
また、今回のように複数のオブジェクトを宣言する場合は、セミコロン `;` 区切りで宣言します。
- この `try` ブロック内で例外が発生した場合は `catch` ブロックを使って捕捉することができます。  
ここではチュートリアルなのでスタックトレースをそのまま表示しているだけですが、実務ではログを出力することが多くなります。
-  `try-with-resources` によって明示的に破棄をする必要がなくなるので、破棄を忘れるリスクがなくなります。  
このため手順-8のデータベース接続関連のオブジェクトを解放の記述は不要になります。

## 4. まとめ

ここのコードで学ぶべきポイント：

  - `try-with-resources` を利用したオブジェクトの解放を省略できること

### 残された問題

このチュートリアルでは以下の問題が残されています：

  - 手順-6の結果セットから商品リストに変換する処理のメソッド化
  - 手順-7の商品リスト表示のメソッド化

これらの問題については、検索の最後のチュートリアルで取り上げます。

---

## 実習問題

以下の課題を進めるにあたっては `jp.example.exercise.t1.all` パッケージの中にクラスを作成してください。  
なお、クラス名は `Exercise11` のように「Exercise + 課題番号」の形式にして `main` メソッドに処理を記述してください。  
たとえば、課題-11の場合は「`Exercise11`」というクラスを作成します。

**［課題-21］** [データベース概要](../00-database.md) を参考にして `employees` テーブルの全件を取得するSQL文を利用して全件を表示するプログラムを `try-with-resources` を利用して書き直してください。

---

[Javaによるデータベース接続とCRUD操作のチュートリアル](../tutorials.md) > [JDBC接続によるCRUD操作](./10-jdbc.md)

