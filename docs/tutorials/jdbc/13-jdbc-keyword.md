# *T1.13* JDBC接続によるCRUD操作・キーワード検索 ～ 商品をキーワード検索してみた編

[Javaによるデータベース接続とCRUD操作のチュートリアル](../tutorials.md) > [JDBC接続によるCRUD操作](./10-jdbc.md)

### 今回のチュートリアル対象

- コミット：[f01640c](https://github.com/612-teacher001/jbasic-dao-demo/commit/f01640c)
- クラス：[`jp.example.app.t1.JdbcKeyword`](https://github.com/612-teacher001/jbasic-dao-demo/blob/main/src/main/java/jp/example/app/t1/JdbcKeyword.java)

👉 チュートリアルの進め方については [チュートリアルガイド](../guidance.md) を参照してください。

## 1. 概要

このチュートリアルで扱うプログラムは、productsテーブルからレコードをキーワード検索で取得して、標準出力に表示するというものです。

このチュートリアルでは、**JDBCの基本の流れ（入力 → 処理 → 表示）を実現する方法** について解説します。

処理結果の表示仕様は以下のとおりです：

  - **取得順序**：商品リストの昇順
  - **出力形式**：商品ID、カテゴリID、商品名、価格、数量
  - **例外処理**：SQL実行中にエラーが発生した場合にはスタックトレースを表示

## 2. 事前準備

データベースの詳細については、データベース接続情報を含めて [データベース概要](../00-database.md) を参照してください。

## 3. 手順ごとの解説

以下で解説する手順は `jp.example.app.t1.JdbcKeyword#main(String[])` メソッドのコードに記述されている「手順-X」と記述されたコメントに対応しています。  
実際にコードを確認しながら読み進めてください。

### 手順-1. 全商品を表示する
- 主キー検索のチュートリアルでの内容を同じです。[商品IDで検索してみた・基本形編](./12-jdbc-id_01.md) を参照してください。

### 手順-2. キーボードから入力された検索キーワードを取得する<a id="keyword"></a>
```java
String keyword = Keyboard.getInputString("検索キーワードを入力してください：");
```
- `Keyboard#getInputString(String)' メソッドを呼び出して、キーボードからの入力を変数に格納します。
- `Keyboard` クラスについては [Keyboard クラス 利用ガイド](../../manuals/provided/keyboard.md) を参照してください。
- 取り込む際には前後の空白があるかどうかを調べる必要がありますが、ここでは省略しています。  
詳しくは [5. 参考メモ：検索キーワードの扱いについて](#memo) を参照してください。


### 手順-3. 実行するSQLを設定する
```java
String sql = "SELECT * FROM products WHERE name LIKE ? ORDER BY id";
```
- ここでは入力されたキーワードを条件として検索するので `WHERE` 句が必要になります。
- 部分一致検索なので `LIKE` 演算子を利用します。  
プレースホルダ `?` にはワイルドカードを含めたキーワードに置き換えます。  
- 未入力または空文字列が入力された場合は全件検索になります（[5. 参考メモ：ワイルドカードと検索方向について](#search_mode) を参照）。
手順-7も参照してください。
- `ORDER BY id` と並び順を指定することによって、検索結果を商品ID順で常に表示できるので確認がしやすくなります。

### 手順-4. データベース接続情報を取得する
```java
DbConfigure configure = new DbConfigure();
```
- ここはこれまでのチュートリアルで扱ったものと同じです。

### 手順-5. データベース接続オブエジェクトを取得する
### 手順-6. SQL実行オブジェクトを取得する
```java
List<Product> productList = new ArrayList<>();
try (// 手順-5. データベース接続オブジェクトを取得（例外処理対象：リソース自動解放のしくみで管理される）
    Connection conn = DriverManager.getConnection(configure.getUrl(), configure.getUser(), configure.getPassword());
    // 手順-6. SQL実行オブジェクトを取得（例外処理対象）
    PreparedStatement pstmt = conn.prepareStatement(sql);
  ) {
```
- try-with-resourcesブロックの直前で、検索結果を格納する商品リスト `productList` を `new ArrayList<>()` で初期化しています。  
この代入文では右辺のジェネリクスが空  `<>` になっていますが、これは左辺のジェネリクス同じなので省略しています。  
このようなしくみを **型推論** といいます。
- tryのオブジェクと宣言部に関しては、主キー検索のチュートリアルでの内容を同じです。[商品IDで検索してみた・基本形編](./12-jdbc-id_01.md) を参照してください。
- ここで宣言されたリソースは自動的に開放されます。

### 手順-7. SQLのプレースホルダを取得した検索キーワードで置換する<a id="data_bind"></a>
```java
pstmt.setString(1, "%" + keyword + "%");
```
- `PreparedStatement#setString(int, String)` メソッドを呼び出して、プレースホルダをキーワードで置換しています。
- ワイルドカード `%` を検索キーワードの前後に追加することで中間一致検索が実行できるようになります（[5. 参考メモ：ワイルドカードと検索方向について](#search_mode) を参照）。

### 手順-8. SQLの実行と結果セットを取得する
### 手順-9. 結果セットから商品リストに変換する
- 主キー検索のチュートリアルでの内容を同じです。[商品IDで検索してみた・基本形編](./12-jdbc-id_01.md) を参照してください。
- `productList.add()` メソッドの引数で商品をインスタンス化している点が主キー検索のサンプルソースと違っていますが、同じ結果になります。

### 手順-10. 商品リストをチェックする
```java
if (productList.size() == 0) {
  Display.showMessageln("検索結果：検索キーワードを含む商品名の商品は見つかりませんでした。");
  return;
}
```
- 手順-5/手順-6におけるtry-with-resourcesブロックの直前で商品リストを空リストで初期化しているので、検索結果が0件の場合は `productList` は空リストのままになります。  
if文ではその判定をしています。
- 検索結果が0件つまり `productList` が空リストである場合はメッセージを表示してプログラムを終了します。  
このとき、プログラムの終了はreturn文を使っていますが、`System.exit(0)` メソッドを呼び出しても同じことになります。

### 手順-11. 商品リストを表示する
-  `productList` に格納されているものは全件検索の場合もキーワード検索の場合も複数の商品インスタンスのリストになります。  
主キー検索のチュートリアルでの内容を同じです。[商品IDで検索してみた・基本形編](./12-jdbc-id_01.md) を参照してください。



## 4. まとめ

ここのコードで学ぶべきポイント：

  - `LIKE` 演算子による検索方向の違い
  - ワイルドカードの意味とその使い方

## 5. 参考メモ

### 検索キーワードの扱いについて<a id="memo"></a>

- 未入力（空文字列）を入力するとSQLの `WHERE` 句の条件は「`LIKE %%`」となり、全件検索が実行されます。
- 入力文字列の前後に余分な空白は含まれていると、検索結果にヒットしない場合があります。  
このサンプルではあえて `trim()` メソッドを使用していませんが、実務では多くの場合、`keyword.trim()` メソッドを使って前後の空白を除去しています。

[ジャンプ元に戻る](#keyword)

### ワイルドカードと検索方向について<a id="search_mode"></a>  

具体的な文字ではなく任意の文字の代表として指定する文字を **ワイルドカード** といいます。  
ワイルドカードには２つの種類があります。以下の表に違いをまとめました：

  | ワイルドカード | 意味 |制限 |
  | --------------| ----| --- |
  | `%` | 任意の文字 | 0文字以上 |
  | `_` | 任意の文字 | 1文字固定 |


検索の向きによる検索方法には、前方一致検索、中間一致検索（部分一致検索またはあいまい検索とも呼ばれる）、後方一致検索といった３つの種類があります。  
これらの検索方法の違いを以下の表にまとめます：
  | 検索方法 | 意味 | ワイルドカードのパターン |
  | ------- | ---- | ---------------------- |
  | 前方一致検索 | 文字列先頭から検索対象文字列パターンが始まるものだけを検索する | *string_pattern*`%` |
  | 中間一致検索 | 文字列に検索対象文字列パターンが含まれているものだけを検索する | `%`*string_pattern*`%` |
  | 後方一致検索 | 文字列末尾が検索対象文字列パターンで終わるものだけを検索する   | `%`*string_pattern* |

[ジャンプ元に戻る](#data_bind)


---

## 実習問題

以下の課題を進めるにあたっては `jp.example.exercise.t1.id` パッケージの中にクラスを作成してください。  
なお、クラス名は `Exercise11` のように「Exercise + 課題番号」の形式にして `main` メソッドに処理を記述してください。  
たとえば、課題-11の場合は「`Exercise11`」というクラスを作成します。

**［課題-11］** [データベース概要](../00-database.md) を参考にして、キーボードから入力された部署IDをもとにdepartmentsテーブルで主キー検索をした結果を表示するプログラムを作ってください。  
このとき、try-with-resourcesを利用して「処理」と「結果の表示」を分けるようにしてください。

---

[Javaによるデータベース接続とCRUD操作のチュートリアル](../tutorials.md) > [JDBC接続によるCRUD操作](./10-jdbc.md)

