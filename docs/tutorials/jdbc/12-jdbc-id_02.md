# *T1.12* JDBC接続によるCRUD操作・主キー検索 ～ 商品IDで検索してみた・改善形編

[Javaによるデータベース接続とCRUD操作のチュートリアル](../tutorials.md) > [JDBC接続によるCRUD操作](./10-jdbc.md)

### 今回のチュートリアル対象

- コミット：[9c7d801](https://github.com/612-teacher001/jbasic-dao-demo/commit/9c7d801)
- クラス：[`jp.example.app.t1.JdbcId`](https://github.com/612-teacher001/jbasic-dao-demo/blob/main/src/main/java/jp/example/app/t1/JdbcId.java)

👉 チュートリアルの進め方については [チュートリアルガイド](../guidance.md) を参照してください。

## 1. 概要

このチュートリアルで扱うプログラムは、productsテーブルから商品ID検索によりレコードを取得して、標準出力に表示するというものです。

このチュートリアルでは、**JDBCの基本の流れ（入力 → 処理 → 表示）を実現する方法** について解説します。

処理結果の表示仕様は以下のとおりです：

  - **取得順序**：商品インスタンスなので指定なし
  - **出力形式**：商品ID、カテゴリID、商品名、価格、数量
  - **例外処理**：SQL実行中にエラーが発生した場合にはスタックトレースを表示

## 2. 事前準備

データベースの詳細については、データベース接続情報を含めて [データベース概要](../00-database.md) を参照してください。

## 3. 手順ごとの解説

以下で解説する手順は `jp.example.app.t1.JdbcId#main(String[])` メソッドのコードに記述されている「手順-X」と記述されたコメントに対応しています。  
実際にコードを確認しながら読み進めてください。

前回の「残された問題」を振り返ってみると、11ある手順を以下のように分類することができます：

| 処理分類 | 手順 | 内容 |
| ------- | ---- | ---  |
| 入力値の受入 | 手順-1から手順-2   | キーボードからの入力値を取得する |
| 処理        | 手順-3から手順-9   | 取得した入力値を元にして主キー検索をする |
| 結果の表示   | 手順-10から手順-11 | 検索結果を表示する |

前回のサンプルソースでは、try-with-resourcesのブロック内に「処理」と「結果の表示」を含めていましたが、これでは「結果の表示」が完了するまで、データベース接続関連オブジェクト（Connection、PreparedStatement、ResultSetなど）は破棄されずに残っています。  
try-with-resources を使うと、例外が発生した場合でもデータベース接続関連オブジェクトなどのリソースは自動的に解放されます（`close()` メソッドが自動で呼ばれる）。  
この仕組みは例外処理の一部として働くため、明示的に `finally` ブロックを書かなくてもリソースの解放を確実に行えます。  
これは従来の try-catch-finally よりもコードが簡潔になる利点があります。

データベース接続関連オブジェクトのようにネットワークのリソースを利用する場合、利用する時間を可能な限り短くすることが必要になります。  
なぜなら、利用する時間が長くなればそれだけネットワークに負荷がかかってしまうからです。  
データベース接続関連オブジェクトも例外ではなく、**不要になったら解放しておく** 必要があります。 

前回のサンプルソースのような設計では結果の表示が完了するまでリソースが開放されないことになり、この「不要になったら解放しておく」という原則に反しています。  
そこで、この原則に沿うために結果の表示をtry-with-resourcesブロックの外に移動します。


## 4. まとめ

ここのコードで学ぶべきポイント：

  - SQLの実行手順（接続 → 実行 → 結果取得）
  - `ResultSet` からインスタンスへの変換方法
  - 例外処理の基本
	- スタックトレースによる簡易例外処理
	- try-with-resourcesによるリソース自動解放のしくみ

---

## 実習問題

以下の課題を進めるにあたっては `jp.example.exercise.t1.id` パッケージの中にクラスを作成してください。  
なお、クラス名は `Exercise11` のように「Exercise + 課題番号」の形式にして `main` メソッドに処理を記述してください。  
たとえば、課題-11の場合は「`Exercise11`」というクラスを作成します。

**［課題-11］** [データベース概要](../00-database.md) を参考にして、キーボードから入力された部署IDをもとにdepartmentsテーブルで主キー検索をした結果を表示するプログラムを作ってください。  
このとき、try-with-resourcesを利用して「処理」と「結果の表示」を分けるようにしてください。

---

[Javaによるデータベース接続とCRUD操作のチュートリアル](../tutorials.md) > [JDBC接続によるCRUD操作](./10-jdbc.md)

